---
title: "p8105_hw3_cw3747"
author: "chuhan wang_cw3747"
date: "2025-10-05"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(patchwork)
library(scales)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem1
### 1.1
```{r}
library(p8105.datasets)
data("instacart")
```

```{r}
instacart <- instacart |>
  janitor::clean_names() 

n_aisles <- n_distinct(instacart$aisle)    ## calculate aisles

aisle_counts <- instacart |>
  count(aisle, name = "n_items") |>       ## count the number of each item
  arrange(desc(n_items))   ## top aisles

n_aisles
head(aisle_counts, 10)
```
There are **`r n_aisles`** aisles in the instacart dataset, and the most orderd items are **`r aisle_counts$aisle[1:3]`**.

### 1.2
```{r}
aisle_counts |>
  filter(n_items > 10000) |>
  mutate(aisle = fct_reorder(aisle, n_items)) |>
  ggplot(aes(x = aisle, y = n_items)) +
  geom_col() +
  coord_flip() +           ## for easy reading
  labs(x = "Aisle", y = "Items ordered", title = ">10k items per aisle") +
  theme_minimal()
```

### 1.3
```{r}
sel_aisles <- c("baking ingredients", "dog food care", "packaged vegetables fruits")

popular_items <- instacart |>
  filter(aisle %in% sel_aisles) |>               ## keep the three aisles
  select(aisle, product_name) |>                  
  count(aisle, product_name, name = "n_orders") |>  ## keep product name and number
  group_by(aisle) |>
  slice_max(n_orders, n = 3, with_ties = FALSE) |>
  arrange(aisle, desc(n_orders)) |>
  ungroup()

popular_items
```

## 1.4
```{r}
library(gt)
products <- c("Pink Lady Apples", "Coffee Ice Cream")

weekday_levels <- c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")    ## to make readable

mean_hour <- instacart |>
  filter(product_name %in% products) |>
  mutate(dow = factor(weekday_levels[order_dow + 1],
                    levels = weekday_levels)) |>
  group_by(product_name, dow) |>
  summarize(mean_hour = mean(order_hour_of_day, na.rm = TRUE), .groups = "drop") |>
  mutate(mean_hour = round(mean_hour, 1)) |>
  pivot_wider(names_from = dow, values_from = mean_hour) |>
  arrange(match(product_name, products))

mean_hour |>
  gt() |>
  tab_header(title = "Mean order time by weekday (hours, 24h)") |>
  cols_label(product_name = "Product")
```

## Description
```{r}
vals <- c(
  nrow(instacart),
  n_distinct(instacart$user_id),
  n_distinct(instacart$order_id),
  n_distinct(instacart$product_id),
  n_distinct(instacart$department),
  n_distinct(instacart$aisle)
)
scales::label_comma()(vals)
```

The Instacart dataset contains **`r format(nrow(instacart), big.mark = ",")` rows** and **`r ncol(instacart)` columns**; each row represents one product within an order. Key variables include order-level fields (`order_id`, `user_id`, `order_number`), timing (0–6 for Sun–Sat, 0–23 for hour), and product metadata (`product_id`, `product_name`, `aisle`, `department`). For example, one observation shows that user 1 bought 8 itmes including Organic Hass Avocado from the “fresh fruits” aisle on day 4 (Thursday) at 10 a.m. This illustrates how each row represents a single product within a specific order.

In total there are **`r format(n_distinct(instacart$user_id), big.mark = ",")` users** making **`r format(n_distinct(instacart$order_id), big.mark = ",")` orders** across **`r n_distinct(instacart$department)` departments** and **`r n_distinct(instacart$aisle)` aisles**, covering **`r format(n_distinct(instacart$product_id), big.mark = ",")` products**.

## Problem2
### clean names
```{r}
zip_info <- read_csv("./zillow_data/Zip Codes.csv") |>
  janitor::clean_names() |>
  mutate(zip_code = as.character(zip_code))

zillow_data <- read_csv("./zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |>
  janitor::clean_names() |>
  rename(zip_code = region_name) |>
  mutate(zip_code = as.character(zip_code))
```

```{r}
zillow_data = zillow_data |>
  pivot_longer(
    cols = starts_with("x20"),
    names_to = "date",
    values_to = "rent_price"
  ) |>
   mutate(
    date = as.Date(str_replace_all(str_remove(date, "x"), "_", "-")),
    .keep = "unused")
```

```{r}
ny_rent = zillow_data |>
  left_join(zip_info, by = "zip_code") |>
  arrange(zip_code, date)
```

### basic count
```{r}
zip_counts <- ny_rent |>
  count(zip_code, name = "n_obs") |>
  arrange(desc(n_obs))

zip_116 <- sum(zip_counts$n_obs == 116)
zip_few  <- sum(zip_counts$n_obs < 10)

zip_116; zip_few
```
There are 147 ZIP codes observed 116 times, and no ZIP code is observed fewer than 10 times. Some ZIP codes are observed rarely due to differences in data availability and market characteristics. This may occur for several reasons: (A) during certain periods, there may have been no available rental units in those ZIP codes; (B) some ZIP codes correspond mainly to business or industrial districts, which are not typically included in Zillow’s rental database; and (C) Zillow may not have updated or maintained complete coverage for certain ZIP codes in a timely manner.

### table
```{r}
ny_rent_year <- ny_rent |>
  mutate(year = lubridate::year(date)) |>
  group_by(county, year) |>
  summarize(mean_rent = mean(rent_price, na.rm = TRUE)) |>
  ungroup()

ny_rent_year |>
  gt() |>
  fmt_number(columns = mean_rent, decimals = 0) |>
  tab_header(title = "Average NYC Rental Price by Borough and Year")
```
Over the past decade, the overall rental price trend in New York City has shown a steady upward trajectory.
There was a temporary decline during 2020–2021, likely reflecting the economic slowdown and reduced housing demand associated with the COVID-19 pandemic, but after 2021, rental prices rebounded sharply and continued to rise through 2023–2024, reaching the highest levels in the dataset. And New York has the highest rent.

### plot
```{r}
ny_rent_year |>
  ggplot(aes(x = year, y = mean_rent, color = county, group = county)) +
  geom_line(size = 1) +
  labs(
    title = "Average NYC Rental Price by County (2015–2024)",
    x = "Year",
    y = "Average Rent ($)",
    color = "County") +
  scale_x_continuous(breaks = seq(2015, 2024, by = 2)) +
  theme_minimal()
```
Manhattan (New York County) consistently exhibits the highest rent levels, followed by Brooklyn (Kings County) and Queens. A temporary decline occurred around 2020–2021, likely due to the COVID-19 pandemic, followed by a steady recovery and continued growth in subsequent years. Bronx and Richmond counties have lower average rents overall but show similar upward trajectories in recent years.

### 2023 rent
```{r}
ny_rent_2023 <- ny_rent |>
  filter(lubridate::year(date) == 2023) |>     
  group_by(zip_code, county) |>               
  summarize(mean_rent = mean(rent_price, na.rm = TRUE)) |>
  ungroup()
```

```{r}
p_zip_2023 <- ny_rent_2023 |>
  ggplot(aes(x = county, y = mean_rent, fill = county)) +
  geom_boxplot() +
  labs(
    title = "Distribution of ZIP-code-level Average Rent Prices (2023)",
    x = "County",
    y = "Average Rent ($)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

p_zip_2023
```

### combine
```{r}
library(ggplot2)
p_year <- ny_rent_year |>
  ggplot(aes(x = year, y = mean_rent, color = county, group = county)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Average NYC Rental Price by County (2015–2024)",
    x = "Year",
    y = "Average Rent ($)",
    color = "County"
  ) +
  scale_x_continuous(breaks = seq(2015, 2024, by = 2)) +
  theme_minimal()

combined_plot <- p_year / p_zip_2023 +
  plot_annotation(title = "NYC Rental Price Trends and 2023 Distribution")

combined_plot
ggsave("results/combined_plot.png", combined_plot, width = 10, height = 8, dpi = 300)
```

## Problem3
### read and clean
```{r}
accel_df = read_csv("./nhanes_accel.csv") |> 
  janitor::clean_names()

covar_df = read_csv("./nhanes_covar.csv", skip = 4, na = c("NA", ".", "")) |> 
  janitor::clean_names()
```

### merge and tidy
```{r}
merged_df = left_join(covar_df, accel_df, by = "seqn") 

clean_df = merged_df |> 
  filter(age >= 21) |>                  
  drop_na() |>     
  mutate(
  sex = recode(sex, `1` = "Male", `2` = "Female"),
  education = recode(education,
                     `1` = "Less than HS",
                     `2` = "High School",
                     `3` = "More than HS"))
```

### sex and education
```{r}
table_df = clean_df |>
  count(sex, education) |>
  pivot_wider(
    names_from = sex,
    values_from = n,
    values_fill = 0
  )

table_df |> 
  gt() |>
  tab_header(
    title = "Number of Men and Women by Education Category"
  )
```

### age/sex/education
```{r}
clean_df |>
  ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~education) +
  labs(
    title = "Age Distributions by Sex and Education Level",
    x = "Age (years)",
    y = "Density",
    fill = "Sex"
  ) +
  theme_minimal()
```

The plots present that actually there is a fairly balanced number of male and female participants across all education levels. Age distributions show that participants with higher education levels tend to be younger on average, while those with less than high school education are generally older, and women in the “More than High School” group appear slightly younger than their male counterparts.


