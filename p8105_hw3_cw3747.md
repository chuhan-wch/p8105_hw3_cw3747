p8105_hw3_cw3747
================
chuhan wang_cw3747
2025-10-05

``` r
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.1
    ## ✔ ggplot2   3.5.2     ✔ tibble    3.3.0
    ## ✔ lubridate 1.9.4     ✔ tidyr     1.3.1
    ## ✔ purrr     1.1.0     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(patchwork)
library(scales)
```

    ## 
    ## Attaching package: 'scales'
    ## 
    ## The following object is masked from 'package:purrr':
    ## 
    ##     discard
    ## 
    ## The following object is masked from 'package:readr':
    ## 
    ##     col_factor

``` r
library(dplyr)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem1

### 1.1

``` r
library(p8105.datasets)
data("instacart")
```

``` r
instacart <- instacart |>
  janitor::clean_names() 

n_aisles <- n_distinct(instacart$aisle)    ## calculate aisles

aisle_counts <- instacart |>
  count(aisle, name = "n_items") |>       ## count the number of each item
  arrange(desc(n_items))   ## top aisles

n_aisles
```

    ## [1] 134

``` r
head(aisle_counts, 10)
```

    ## # A tibble: 10 × 2
    ##    aisle                         n_items
    ##    <chr>                           <int>
    ##  1 fresh vegetables               150609
    ##  2 fresh fruits                   150473
    ##  3 packaged vegetables fruits      78493
    ##  4 yogurt                          55240
    ##  5 packaged cheese                 41699
    ##  6 water seltzer sparkling water   36617
    ##  7 milk                            32644
    ##  8 chips pretzels                  31269
    ##  9 soy lactosefree                 26240
    ## 10 bread                           23635

There are **134** aisles in the instacart dataset, and the most orderd
items are **fresh vegetables, fresh fruits, packaged vegetables
fruits**.

### 1.2

``` r
aisle_counts |>
  filter(n_items > 10000) |>
  mutate(aisle = fct_reorder(aisle, n_items)) |>
  ggplot(aes(x = aisle, y = n_items)) +
  geom_col() +
  coord_flip() +           ## for easy reading
  labs(x = "Aisle", y = "Items ordered", title = ">10k items per aisle") +
  theme_minimal()
```

<img src="p8105_hw3_cw3747_files/figure-gfm/unnamed-chunk-4-1.png" width="90%" />

### 1.3

``` r
sel_aisles <- c("baking ingredients", "dog food care", "packaged vegetables fruits")

popular_items <- instacart |>
  filter(aisle %in% sel_aisles) |>               ## keep the three aisles
  select(aisle, product_name) |>                  
  count(aisle, product_name, name = "n_orders") |>  ## keep product name and number
  group_by(aisle) |>
  slice_max(n_orders, n = 3, with_ties = FALSE) |>
  arrange(aisle, desc(n_orders)) |>
  ungroup()

popular_items
```

    ## # A tibble: 9 × 3
    ##   aisle                      product_name                               n_orders
    ##   <chr>                      <chr>                                         <int>
    ## 1 baking ingredients         Light Brown Sugar                               499
    ## 2 baking ingredients         Pure Baking Soda                                387
    ## 3 baking ingredients         Cane Sugar                                      336
    ## 4 dog food care              Snack Sticks Chicken & Rice Recipe Dog Tr…       30
    ## 5 dog food care              Organix Chicken & Brown Rice Recipe              28
    ## 6 dog food care              Small Dog Biscuits                               26
    ## 7 packaged vegetables fruits Organic Baby Spinach                           9784
    ## 8 packaged vegetables fruits Organic Raspberries                            5546
    ## 9 packaged vegetables fruits Organic Blueberries                            4966

## 1.4

``` r
products <- c("Pink Lady Apples", "Coffee Ice Cream")

weekday_levels <- c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")    ## to make readable

mean_hour <- instacart |>
  filter(product_name %in% products) |>
  mutate(dow = factor(weekday_levels[order_dow + 1],
                    levels = weekday_levels)) |>
  group_by(product_name, dow) |>
  summarize(mean_hour = mean(order_hour_of_day, na.rm = TRUE), .groups = "drop") |>
  mutate(mean_hour = round(mean_hour, 1)) |>
  pivot_wider(names_from = dow, values_from = mean_hour) |>
  arrange(match(product_name, products))

knitr::kable(mean_hour, format = "pipe", digits = 1,
             col.names = c("Product","Sun","Mon","Tue","Wed","Thu","Fri","Sat"),
             caption = "Mean order time by weekday (hours, 24h)")
```

| Product          |  Sun |  Mon |  Tue |  Wed |  Thu |  Fri |  Sat |
|:-----------------|-----:|-----:|-----:|-----:|-----:|-----:|-----:|
| Pink Lady Apples | 13.4 | 11.4 | 11.7 | 14.2 | 11.6 | 12.8 | 11.9 |
| Coffee Ice Cream | 13.8 | 14.3 | 15.4 | 15.3 | 15.2 | 12.3 | 13.8 |

Mean order time by weekday (hours, 24h)

## Description

``` r
vals <- c(
  nrow(instacart),
  n_distinct(instacart$user_id),
  n_distinct(instacart$order_id),
  n_distinct(instacart$product_id),
  n_distinct(instacart$department),
  n_distinct(instacart$aisle)
)
scales::label_comma()(vals)
```

    ## [1] "1,384,617" "131,209"   "131,209"   "39,123"    "21"        "134"

The Instacart dataset contains **1,384,617 rows** and **15 columns**;
each row represents one product within an order. Key variables include
order-level fields (`order_id`, `user_id`, `order_number`), timing (0–6
for Sun–Sat, 0–23 for hour), and product metadata (`product_id`,
`product_name`, `aisle`, `department`). For example, one observation
shows that user 1 bought 8 itmes including Organic Hass Avocado from the
“fresh fruits” aisle on day 4 (Thursday) at 10 a.m. This illustrates how
each row represents a single product within a specific order.

In total there are **131,209 users** making **131,209 orders** across
**21 departments** and **134 aisles**, covering **39,123 products**.

## Problem2

### clean names

``` r
zip_info <- read_csv("./zillow_data/Zip Codes.csv") |>
  janitor::clean_names() |>
  mutate(zip_code = as.character(zip_code))
```

    ## Rows: 322 Columns: 7
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (4): County, County Code, File Date, Neighborhood
    ## dbl (3): State FIPS, County FIPS, ZipCode
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
zillow_data <- read_csv("./zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |>
  janitor::clean_names() |>
  rename(zip_code = region_name) |>
  mutate(zip_code = as.character(zip_code))
```

    ## Rows: 149 Columns: 125
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr   (6): RegionType, StateName, State, City, Metro, CountyName
    ## dbl (119): RegionID, SizeRank, RegionName, 2015-01-31, 2015-02-28, 2015-03-3...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
zillow_data = zillow_data |>
  pivot_longer(
    cols = starts_with("x20"),
    names_to = "date",
    values_to = "rent_price"
  ) |>
   mutate(
    date = as.Date(str_replace_all(str_remove(date, "x"), "_", "-")),
    .keep = "unused")
```

``` r
ny_rent = zillow_data |>
  left_join(zip_info, by = "zip_code") |>
  arrange(zip_code, date)
```

    ## Warning in left_join(zillow_data, zip_info, by = "zip_code"): Detected an unexpected many-to-many relationship between `x` and `y`.
    ## ℹ Row 4757 of `x` matches multiple rows in `y`.
    ## ℹ Row 256 of `y` matches multiple rows in `x`.
    ## ℹ If a many-to-many relationship is expected, set `relationship =
    ##   "many-to-many"` to silence this warning.

### basic count

``` r
zip_counts <- ny_rent |>
  count(zip_code, name = "n_obs") |>
  arrange(desc(n_obs))

zip_116 <- sum(zip_counts$n_obs == 116)
zip_few  <- sum(zip_counts$n_obs < 10)

zip_116; zip_few
```

    ## [1] 147

    ## [1] 0

There are 147 ZIP codes observed 116 times, and no ZIP code is observed
fewer than 10 times. Some ZIP codes are observed rarely due to
differences in data availability and market characteristics. This may
occur for several reasons: (A) during certain periods, there may have
been no available rental units in those ZIP codes; (B) some ZIP codes
correspond mainly to business or industrial districts, which are not
typically included in Zillow’s rental database; and (C) Zillow may not
have updated or maintained complete coverage for certain ZIP codes in a
timely manner.

### table

``` r
ny_rent_year <- ny_rent |>
  mutate(year = lubridate::year(date)) |>
  group_by(county, year) |>
  summarize(mean_rent = mean(rent_price, na.rm = TRUE)) |>
  ungroup()
```

    ## `summarise()` has grouped output by 'county'. You can override using the
    ## `.groups` argument.

``` r
ny_rent_year_wide <- ny_rent_year |>
  dplyr::mutate(mean_rent = round(mean_rent, 0)) |>
  tidyr::pivot_wider(
    names_from = year,
    values_from = mean_rent
  ) |>
  dplyr::rename(Borough = county) |>
  dplyr::arrange(match(Borough, c("Manhattan","Kings","Queens","Bronx","Richmond")))

knitr::kable(
  ny_rent_year_wide,
  format  = "pipe",
  caption = "Average NYC Rental Price by Borough and Year",
  digits  = 0
)
```

| Borough  | 2015 | 2016 | 2017 | 2018 | 2019 | 2020 | 2021 | 2022 | 2023 | 2024 |
|:---------|-----:|-----:|-----:|-----:|-----:|-----:|-----:|-----:|-----:|-----:|
| Kings    | 2493 | 2520 | 2546 | 2547 | 2631 | 2555 | 2550 | 2868 | 3015 | 3126 |
| Queens   | 2215 | 2272 | 2263 | 2292 | 2388 | 2316 | 2211 | 2406 | 2562 | 2694 |
| Bronx    | 1760 | 1520 | 1544 | 1639 | 1706 | 1811 | 1858 | 2054 | 2285 | 2497 |
| Richmond |  NaN |  NaN |  NaN |  NaN |  NaN | 1978 | 2045 | 2147 | 2333 | 2536 |
| New York | 3006 | 3015 | 3109 | 3160 | 3285 | 3091 | 3124 | 3753 | 3908 | 4053 |

Average NYC Rental Price by Borough and Year

Over the past decade, the overall rental price trend in New York City
has shown a steady upward trajectory. There was a temporary decline
during 2020–2021, likely reflecting the economic slowdown and reduced
housing demand associated with the COVID-19 pandemic, but after 2021,
rental prices rebounded sharply and continued to rise through 2023–2024,
reaching the highest levels in the dataset. And New York has the highest
rent.

### plot

``` r
ny_rent_year |>
  ggplot(aes(x = year, y = mean_rent, color = county, group = county)) +
  geom_line(size = 1) +
  labs(
    title = "Average NYC Rental Price by County (2015–2024)",
    x = "Year",
    y = "Average Rent ($)",
    color = "County") +
  scale_x_continuous(breaks = seq(2015, 2024, by = 2)) +
  theme_minimal()
```

    ## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
    ## ℹ Please use `linewidth` instead.
    ## This warning is displayed once every 8 hours.
    ## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
    ## generated.

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_line()`).

<img src="p8105_hw3_cw3747_files/figure-gfm/unnamed-chunk-13-1.png" width="90%" />

Manhattan (New York County) consistently exhibits the highest rent
levels, followed by Brooklyn (Kings County) and Queens. A temporary
decline occurred around 2020–2021, likely due to the COVID-19 pandemic,
followed by a steady recovery and continued growth in subsequent years.
Bronx and Richmond counties have lower average rents overall but show
similar upward trajectories in recent years.

### 2023 rent

``` r
ny_rent_2023 <- ny_rent |>
  filter(lubridate::year(date) == 2023) |>     
  group_by(zip_code, county) |>               
  summarize(mean_rent = mean(rent_price, na.rm = TRUE)) |>
  ungroup()
```

    ## `summarise()` has grouped output by 'zip_code'. You can override using the
    ## `.groups` argument.

``` r
p_zip_2023 <- ny_rent_2023 |>
  ggplot(aes(x = county, y = mean_rent, fill = county)) +
  geom_boxplot() +
  labs(
    title = "Distribution of ZIP-code-level Average Rent Prices (2023)",
    x = "County",
    y = "Average Rent ($)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

p_zip_2023
```

    ## Warning: Removed 24 rows containing non-finite outside the scale range
    ## (`stat_boxplot()`).

<img src="p8105_hw3_cw3747_files/figure-gfm/unnamed-chunk-15-1.png" width="90%" />

### combine

``` r
library(ggplot2)
p_year <- ny_rent_year |>
  ggplot(aes(x = year, y = mean_rent, color = county, group = county)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Average NYC Rental Price by County (2015–2024)",
    x = "Year",
    y = "Average Rent ($)",
    color = "County"
  ) +
  scale_x_continuous(breaks = seq(2015, 2024, by = 2)) +
  theme_minimal()

borough_order <- c("New York", "Kings", "Queens", "Bronx", "Richmond")
if (!all(borough_order %in% unique(ny_rent_year$county))) {
  borough_order <- unique(ny_rent_year$county)
}

mk_small <- function(cty) {
  ny_rent_year %>%
    filter(county == cty) %>%
    ggplot(aes(x = year, y = mean_rent)) +
    geom_line(linewidth = 0.9) +
    geom_point(size = 1.6) +
    labs(title = cty, x = NULL, y = NULL) +
    scale_x_continuous(breaks = seq(2015, 2024, by = 3)) +
    theme_minimal(base_size = 10) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 11),
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
}

small_list <- lapply(borough_order, mk_small)
p_each_borough <- wrap_plots(small_list, ncol = length(small_list))

combined_plot <- p_year / p_zip_2023 / p_each_borough +
  plot_layout(heights = c(1, 1.6, 0.9)) +
  plot_annotation(
    title = "NYC Rental Price Trends and ZIP-level View",
    caption = "Top: County-level; Middle: ZIP-level; Bottom: Each county mini-trend."
  )

combined_plot
```

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_line()`).

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

    ## Warning: Removed 24 rows containing non-finite outside the scale range
    ## (`stat_boxplot()`).

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_line()`).

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

<img src="p8105_hw3_cw3747_files/figure-gfm/unnamed-chunk-16-1.png" width="90%" />

``` r
ggsave("results/combined_plot.png", combined_plot, width = 10, height = 8, dpi = 300)
```

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_line()`).
    ## Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

    ## Warning: Removed 24 rows containing non-finite outside the scale range
    ## (`stat_boxplot()`).

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_line()`).

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

## Problem3

### read and clean

``` r
accel_df = read_csv("./nhanes_accel.csv") |> 
  janitor::clean_names()
```

    ## Rows: 250 Columns: 1441
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (1441): SEQN, min1, min2, min3, min4, min5, min6, min7, min8, min9, min1...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
covar_df = read_csv("./nhanes_covar.csv", skip = 4, na = c("NA", ".", "")) |> 
  janitor::clean_names()
```

    ## Rows: 250 Columns: 5
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (5): SEQN, sex, age, BMI, education
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

### merge and tidy

``` r
merged_df = left_join(covar_df, accel_df, by = "seqn") 

clean_df = merged_df |> 
  filter(age >= 21) |>                  
  drop_na() |>     
  mutate(
  sex = recode(sex, `1` = "Male", `2` = "Female"),
  education = recode(education,
                     `1` = "Less than HS",
                     `2` = "High School",
                     `3` = "More than HS"))
```

### sex and education

``` r
table_df = clean_df |>
  count(sex, education) |>
  pivot_wider(
    names_from = sex,
    values_from = n,
    values_fill = 0
  )

table_df |>
  dplyr::rename(Education = education) |>
  knitr::kable(
    format  = "pipe",
    caption = "Number of Men and Women by Education Category"
  )
```

| Education    | Female | Male |
|:-------------|-------:|-----:|
| High School  |     23 |   35 |
| Less than HS |     28 |   27 |
| More than HS |     59 |   56 |

Number of Men and Women by Education Category

### age/sex/education

``` r
clean_df |>
  ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~education) +
  labs(
    title = "Age Distributions by Sex and Education Level",
    x = "Age (years)",
    y = "Density",
    fill = "Sex"
  ) +
  theme_minimal()
```

<img src="p8105_hw3_cw3747_files/figure-gfm/unnamed-chunk-20-1.png" width="90%" />

The plots present that actually there is a fairly balanced number of
male and female participants across all education levels. Age
distributions show that participants with higher education levels tend
to be younger on average, while those with less than high school
education are generally older, and women in the “More than High School”
group appear slightly younger than their male counterparts.

### sum activity

``` r
activity_df = clean_df |>
  mutate(total_activity = rowSums(across(starts_with("min")), na.rm = TRUE))

print(
  ggplot(activity_df, aes(x = age, y = total_activity, color = sex)) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "loess", se = FALSE) +
    facet_wrap(~education) +
    labs(
      title = "Total Daily Activity vs Age by Sex and Education Level",
      x = "Age (years)",
      y = "Total Daily MIMS (Sum of 24-hour readings)",
      color = "Sex"
    ) +
    theme_minimal()
)
```

    ## `geom_smooth()` using formula = 'y ~ x'

<img src="p8105_hw3_cw3747_files/figure-gfm/unnamed-chunk-21-1.png" width="90%" />

We can see from the plot that among participants with High School and
Less than High School education, both men and women show a clear decline
in total MIMS values as age increases. In contrast, the More than High
School group shows a flatter pattern, suggesting that higher-educated
individuals may maintain a more stable activity level across age. What’s
more, female participants appear to have slightly higher activity levels
than males in some age ranges, especially among those with High School
education, but the differences are modest.

### each seqn level

``` r
library(tidyverse)

hourly_df = clean_df |>
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    names_prefix = "min",
    values_to = "mims"
  ) |>
  mutate(
    minute = as.numeric(minute),
    hour = minute / 60    
  )
```

``` r
hourly_df |>
  group_by(education, sex, minute) |>
  summarize(mean_mims = mean(mims, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = minute / 60, y = mean_mims, color = sex)) +
  geom_line(size = 1) +
  geom_smooth(se = FALSE, linewidth = 1.2) +
  facet_wrap(~education) +
  labs(
    title = "Average 24-Hour Activity Pattern by Education and Sex",
    x = "Hour of the Day",
    y = "Mean MIMS (Activity Intensity)",
    color = "Sex"
  ) +
  scale_x_continuous(breaks = seq(0, 24, by = 6), limits = c(0, 24)) +
  theme_minimal()
```

    ## `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'

<img src="p8105_hw3_cw3747_files/figure-gfm/unnamed-chunk-23-1.png" width="90%" />

From the plots we can see activity levels are lowest during nighttime
hours (approximately 0:00–5:00) and rise sharply in the morning after
waking up (around 6:00). The activity peak appears between 8:00 and
10:00, followed by a gradual decline in the afternoon and evening.
Participants with More than High School education tend to show more
consistent patterns throughout the day, and differences between men and
women are small.females show marginally higher daytime activity
especially in High School and More than HS group. These patterns are
consistent with typical human circadian activity cycles and may reflect
differences between different education level.
